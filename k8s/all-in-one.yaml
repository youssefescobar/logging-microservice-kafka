# all-in-one.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: logging-stack

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb
  namespace: logging-stack
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:latest
        ports:
        - containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: admin
        - name: MONGO_INITDB_ROOT_PASSWORD
          value: password
        volumeMounts:
        - name: mongo-storage
          mountPath: /data/db
      volumes:
      - name: mongo-storage
        emptyDir: {}  # ← NO PVC!

---
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: logging-stack
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka
  namespace: logging-stack
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
      - name: kafka
        image: apache/kafka:3.8.0
        ports:
        - containerPort: 9092
        - containerPort: 9093
        env:
        - name: CLUSTER_ID
          value: "5L6g3nShT-eMCtK--X86sw"
        - name: KAFKA_NODE_ID
          value: "1"
        - name: KAFKA_PROCESS_ROLES
          value: "broker,controller"
        - name: KAFKA_CONTROLLER_QUORUM_VOTERS
          value: "1@kafka:9093"
        - name: KAFKA_LISTENERS
          value: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://kafka:9092"
        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
          value: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
        - name: KAFKA_CONTROLLER_LISTENER_NAMES
          value: "CONTROLLER"
        - name: KAFKA_INTER_BROKER_LISTENER_NAME
          value: "PLAINTEXT"
        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
          value: "1"
        - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
          value: "true"
        volumeMounts:
        - name: kafka-storage
          mountPath: /kafka/logs
      volumes:
      - name: kafka-storage
        emptyDir: {}  # ← NO PVC!

---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: logging-stack
spec:
  selector:
    app: kafka
  ports:
  - name: plaintext
    port: 9092
    targetPort: 9092
  - name: controller
    port: 9093
    targetPort: 9093
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: logging-ms
  namespace: logging-stack
spec:
  replicas: 1
  selector:
    matchLabels:
      app: logging-ms
  template:
    metadata:
      labels:
        app: logging-ms
    spec:
      containers:
      - name: logging-ms
        image: 582520650777.dkr.ecr.eu-north-1.amazonaws.com/logging-ms:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 5000
        command: ["node"]
        args: ["src/logging/interfaces/index.js"]
        env:
        - name: MONGODB_URL
          value: "mongodb://admin:password@mongodb:27017/logging"
        - name: KAFKA_BROKERS
          value: "kafka:9092"
        - name: KAFKAJS_NO_PARTITIONER_WARNING
          value: "1"

---
apiVersion: v1
kind: Service
metadata:
  name: logging-ms
  namespace: logging-stack
spec:
  type: LoadBalancer
  selector:
    app: logging-ms
  ports:
  - port: 5000
    targetPort: 5000